
@model Connect4m_Web.Models.ResultsModel
@{
    ViewData["Title"] = "PostResults";
}

<!DOCTYPE html>
<html>
<head>
    <style>
        .Ddlstyle {
            width: 230px;
            color: black;
            font-size: inherit;
            height: 27px;
        }

        .errorboxshadow {
            box-shadow: 0 0 0 0.25rem rgb(223 16 35 / 75%);
        }


        /*this are  for design input step 3 page*/
        .thumbnailleft {
            position: relative;
            display: inline-block;
        }

            .thumbnailleft img {
                display: none;
                position: absolute;
                top: 100%;
                left: 0;
                border: 1px solid #cbcbcb;
                z-index: 1;
            }

            .thumbnailleft:hover img {
                display: block;
            }
    </style>



</head>
<body>
    <div class="card">
        <div class="card-header pb-0" style="padding-top: 0px;">
            <h6 style="text-align: center; color: black; margin-top: 5px; "><strong>POST RESULTS</strong></h6>
        </div>
        <span class="ErrorMessageSpan" id="Main_Span_Error"></span>
        <span class="ErrorMessageSpan" id="StudentEmail_Error"></span>
        <span class="ErrorMessageSpan" id="ParentEmail_Error"></span>
        <div class="default-according style-1" id="Div_Step1">
            <div class="card-body" style=" padding-top: 0px;">
                <div class="card" id="Searchpage">

                    <div class="card-header " style="background-color:black ;">
                        <h5 class="mb-0">
                            <button class="btn btn-link text-white" data-bs-toggle="collapse" aria-expanded="true" data-bs-target="#collapseicon1200" aria-controls="collapse11">
                                <span> POST RESULTS </span>
                            </button>
                        </h5>
                    </div>
                    <div class="collapse show" id="collapseicon1200" aria-labelledby="collapseicon" data-bs-parent="#accordionoc9" style="">
                        <div class="card ">
                            <div class="card-body">
                                @*<form id="FmExamsCreatePage" asp-action="ManageExams" asp-controller="Examination">*@

                                <form id="FmSubjectsSearch">
                                    <div asp-validation-summary="ModelOnly" class="text-danger"></div>
                                    <div class="row">
                                        @*<input asp-for="InstanceSubjectId" class="form-control" id="formInstanceSubjectId" hidden />*@

                                        <div class="col-3"></div>

                                        <div class="form-group col-2">
                                            <label class="control-label space">Department :</label>
                                        </div>
                                        <div class="form-group col-4">
                                            <div id="Drop_Format_SEM_3">
                                                <select id='DdlDepartment' asp-for="InstanceClassificationId" name="InstanceClassificationId" onchange="CommonDropdownFunction('GET', '/Attendance/DdlClassId_Calingfunction?InstanceClassificationId=' + this.value, 'DdlClass', 'Please select a Class', true)" class="form-select readonly" asp-items="@(new SelectList(""))">
                                                    <option value=''>Select a Department</option>
                                                </select>
                                                <span asp-validation-for="InstanceClassificationId" class="ErrorMessageSpan"></span>

                                            </div>
                                        </div>
                                        <div class="col-3"></div>
                                        <div class="col-3"></div>
                                        <div class="form-group col-2">
                                            <label class="control-label space">Class :</label>
                                        </div>
                                        <div class="form-group col-4">
                                            <select id='DdlClass' asp-for="InstanceSubClassificationId" name="InstanceSubClassificationId" onchange="CommonDropdownFunction('POST','/Results/DdlSubjectTypes_Calingfunction','DdlSubjects','',false,'FmSubjectsSearch')" class="form-select readonly" asp-items="@(new SelectList(""))" disabled>
                                                <option value=''>Please select a Class</option>
                                            </select>
                                            <span asp-validation-for="InstanceSubClassificationId" class="ErrorMessageSpan"></span>
                                        </div>
                                        <div class="col-3"></div>
                                        <div class="col-3"></div>
                                        <div class="form-group col-2">
                                            <label class="control-label space">Subjects :</label>
                                        </div>
                                        <div class="form-group col-4">
                                            <select id='DdlSubjects' multiple="multiple" style="height: 10%;" asp-for="SubjectsIdString" name="SubjectsIdString" class="form-select readonly" asp-items="@(new SelectList(""))">
                                            </select>
                                            <span asp-validation-for="SubjectsIdString" class="ErrorMessageSpan"></span>
                                        </div>
                                        <div class="col-3"></div>
                                        <div class="col-3"></div>
                                        <div class="form-group col-2">
                                            <label class="control-label space">Exam Type :</label>
                                        </div>
                                        <div class="form-group col-4">
                                            <div id="Drop_Format_SEM_3">
                                                <select id='DdlExamtype' asp-for="ExamtypeId" name="ExamtypeId" onchange="CommonDropdownFunction('POST', '/Results/DdlExams_Callingfunction', 'DdlExam', '------Select------', true,'FmSubjectsSearch')" class="form-select readonly" asp-items="@(new SelectList(""))">
                                                    <option value=''>Select Exam Type</option>
                                                    <option value="1">Academics</option>
                                                    <option value="2">Final Exam</option>
                                                </select>
                                                <span asp-validation-for="ExamtypeId" class="ErrorMessageSpan"></span>
                                            </div>
                                        </div>
                                        <div class="col-3"></div>
                                        <div class="col-3"></div>
                                        <div class="form-group col-2">
                                            <label class="control-label space"> Exams :</label>
                                        </div>
                                        <div class="form-group col-4">
                                            <div id="Drop_Format_SEM_2">
                                                <select id='DdlExam' asp-for="ExamId" name="ExamId" class="form-select readonly" asp-items="@(new SelectList(""))" disabled>
                                                </select>
                                                <span asp-validation-for="ExamId" class="ErrorMessageSpan"></span>
                                            </div>
                                        </div>

                                        <div class="col-3"></div>
                                        <div class="col-3"></div>
                                        <div class="form-group col-2">
                                            <label class="control-label space"> Exam Mode :</label>
                                        </div>
                                        <div class="form-group col-4">
                                            <div id="Drop_Format_SEM_2">
                                                <select id='DdlExammode' asp-for="ExamModeId" name="ExamModeId" class="form-select readonly" asp-items="@(new SelectList(""))">
                                                    <option value=''>------Select------</option>
                                                </select>
                                                <span asp-validation-for="ExamModeId" class="ErrorMessageSpan"></span>
                                            </div>
                                        </div>

                                        <div class="col-3"></div>
                                        <div class="col-3"></div>
                                        <div class="form-group col-2">
                                            <label class="control-label space">Sort By :</label>
                                        </div>
                                        <div class="form-group col-4  m-checkbox-inline mb-0 custom-radio-ml m-t-5" style="margin-left: 20px;">
                                            <div class="radio radio-primary">
                                                <input name="SortBy" asp-for="SortBy" checked="checked" style="padding-top: 0px" id="Name" class="check" type="radio" value="0">
                                                <label class="mb-0" for="Name">Name</label>
                                            </div>
                                            &nbsp;
                                            <div class="radio radio-primary">
                                                <input name="SortBy" asp-for="SortBy" id="Registration" class="check" type="radio" value="1">
                                                <label class="mb-0" for="Registration">
                                                    Registration Number
                                                </label>
                                            </div>
                                        </div>

                                        <div class="col-3"></div>
                                        <div class="col-3"></div>
                                        <div style=" display: flex; gap: 17px;">
                                            <div class="col-4"></div>
                                            <input type="reset" value="Clear" id="BtnRefresh" class="btn btn-pill btn-outline-warning btn-air-warning" />
                                            <input type="submit" value="Go to step 2 of Post Results" id="BtnNextpage_Step2" class="btn btn-pill btn-outline-info btn-air-info" />
                                        </div>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!--This is Step 2-->
        <div id="Div_Step2">
            @*Step 2 Searched Results*@
            <div id="Div_TblExamSubjects" style="display:none">
                <div class="default-according style-1" id="accordionoc123456">

                    <div class="card" id="SearchedTablePage">
                        <span id="DepartmentName" style="margin-left:25%;">
                            @*Step 1 Selection:JUNIOR-PROGRAM-II - A,Md-Term,NORMAL*@
                        </span>
                        <div class="card-header " style="background-color:black ;">
                            <h5 class="mb-0">
                                <button class="btn btn-link text-white" data-bs-toggle="collapse" data-bs-target="#collapseicon1" aria-expanded="true" aria-controls="collapse11">@*<i class="icofont icofont-briefcase-alt-2"></i>*@  <span id="CountOfRecords_LeaveLevels">YOUR SEARCH RESULTED <span id="Counts" class="number-circle">0</span> RECORD(S).</span></button>
                            </h5>
                        </div>
                        <div class="collapse show" id="collapseicon1" aria-labelledby="collapseicon" data-bs-parent="#accordionoc123456" style="">
                            <div class="card ">
                                <form id="Fm_TblUser" class="table-responsive">
                                    @*<table id="LeaveLevels_SearchRecords_Table" class="table table-responsive tableid">*@
                                    <table id="TblExamSubjects" class="display cell-border  tableid">
                                        <thead>
                                            <tr>
                                                <th style="width:2%">S.No</th>
                                                @*<th>ExamSubjectId</th>*@
                                                <th style="width:11%">Subject</th>
                                                <th>Include In Total</th>
                                                <th>Conducted Date</th>
                                                <th>Pass Marks</th>
                                                <th>Max Marks</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                        </tbody>
                                    </table>
                                    <div style=" display: flex; gap: 17px;">
                                        <div class="col-4"></div>
                                        <input type="button" value="Go Back to Step 1" id="BtnBackTo_Step1" onclick="BackTOStep(event)" class="btn btn-pill btn-outline-warning btn-air-warning" />
                                        @*<input type="submit" value="Save & Go to Step 3" onclick="Div_Step3(event)" id="BtnSave_Nextpage_Step3" class="btn btn-pill btn-outline-info btn-air-info" />*@
                                        <input type="submit" value="Save & Go to Step 3" id="BtnSave_Nextpage_Step3" class="btn btn-pill btn-outline-info btn-air-info" />
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!--This is Step 3-->


        <div id="Div_Step3" style="display:none">
            <div class="default-according style-1" id="Div_ChooseOptionFile">

                <!--card 1 in step 3-->
                <div style=" padding-top: 0px;" id="ChooseOptionFile">
                    <div class="card">
                        <span id="DepartmentNameStep3" style="margin-left:25%;">
                            @*Step 1 Selection:JUNIOR-PROGRAM-II - A,Md-Term*@
                        </span>
                        <div class="card-header " style="background-color:black ;">
                            <h5 class="mb-0">
                                <button class="btn btn-link text-white" data-bs-toggle="collapse" aria-expanded="true" data-bs-target="#collapseicon12001A1" aria-controls="collapse11">
                                    <span>
                                        CHOOSE OPTION TO SAVE
                                    </span>
                                </button>
                            </h5>
                        </div>
                        <div class="collapse show" id="collapseicon12001A1" aria-labelledby="collapseicon" data-bs-parent="#accordionoc91" style="">
                            <div class="card ">
                                <div class="card-body">
                                    <form id="FmChooseOption">
                                        <div style="margin-left: 20%; font-size: 12px;" id="UpdateSubjects_Div">
                                            <div class="row">
                                                <div class="form-group col-2">
                                                    <label class="control-label space">Upload File</label>
                                                </div>
                                                <div class="form-group col-4 m-checkbox-inline mb-0 custom-radio-ml m-t-5" style="margin-left: 20px;">
                                                    <div class="radio radio-primary">
                                                        <input id="RdbYes" name="SortBy" style="padding-top: 0px;" class="check" type="radio" value="0">
                                                        <label class="mb-0" for="RdbYes">Yes</label>
                                                    </div>
                                                    &nbsp;
                                                    <div class="radio radio-primary">
                                                        <input id="RdbNo" name="SortBy" class="check" type="radio" value="1">
                                                        <label class="mb-0" for="RdbNo">No</label>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="Div_UploadingType">
                </div>
            </div>
        </div>
    </div>
    @section Scripts {
        @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
    }
</body>
</html>
<script src="https://code.jquery.com/jquery-3.6.2.min.js" integrity="sha256-2krYZKh//PcchRtd+H+VyyQoZ/e3EcrkxhM8ycwASPA=" crossorigin="anonymous"></script>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="~/js/GeneralFunctions.js"></script>
<link href="~/Datatable/jquery.dataTables.css" rel="stylesheet" />
<script src="~/Datatable/jquery.dataTables.min.js"></script>
<script>
    var ErrorAppend = $("#Main_Span_Error");
    $(document).ready(function () {
        $("#loadingOverlay").show();
        //  TblDataTableWithColumns_CallingFunction(event, 'Stop', "/Examination/TblBulkUploadSubjectsList", 'TblBulkUploadSubjectsList', 'Counts', 'FmSubjectSearch', 'Div_TblBulkUploadSubjectsList', '', []);
        CommonDropdownFunction("GET", "/Attendance/DepartmentsDropdown_Caliingfunction", "DdlDepartment", "Select a Department", false)
        CommonDropdownFunction("GET", "/Results/DdlExamMode_Callingfunction", "DdlExammode", "------Select------", false)
        $("#loadingOverlay").hide();
    });
    var js = jQuery.noConflict(true);


   


    //upload file yes or No
    js('#RdbNo,#RdbYes').click(function (event) {
        try {
            debugger;
            event.preventDefault();
            var btnname = $(this).val();
            var MarksUploadtype;
            if (btnname == "1") {
                MarksUploadtype = "UploadWithOutExcelFile";
            } else {
                MarksUploadtype = "UploadWithExcelFile";
            }
            var selectedValues = $("#DdlSubjects option:selected").map(function () {
                return $(this).text();
            }).get();
            if (selectedValues) {
                var selectedValuesString = selectedValues.join(", ");
            }
            var formData = new FormData($("#FmSubjectsSearch")[0]);

            formData.append("SubjectsName", selectedValuesString)


            var TblExamSubject = $("#TblExamSubjects tbody tr");

            TblExamSubject.each(function (index) {
                TblExamSubjectTD = $(this).find("td");

               // var HdnSubjectId = TblExamSubjectTD.find("#SubjectId").val();
                var HdnExamSubjectId = TblExamSubjectTD.find("#ExamSubjectId").val();
                var TxtPassMarks = TblExamSubjectTD.find("#TxtPassMarks").val();
                var TxtMaxMarks = TblExamSubjectTD.find("#TxtMaxMarks").val();

               // formData.append("SubjectIdList", parseInt(HdnSubjectId) || 0);
                formData.append("ExamSubjectIdList", parseInt(HdnExamSubjectId) || 0);
                formData.append("PassMarksList", parseFloat(TxtPassMarks));
                formData.append("MaxMarksList", parseFloat(TxtMaxMarks));
            });

            // var formData = { MarksUploadtype: "UploadWithExcelFile" };
            $("#loadingOverlay").show();
            performCrudOperationCommonFunction("POST", "/Results/PublishResults_Step3?MarksUploadtype=" + MarksUploadtype, formData, function (response) {
                // $("#Div_Step2").hide();
                $("#Div_UploadingType").html(response);
                $("#loadingOverlay").hide();
            }, function (error) {
                $("#loadingOverlay").hide();
                $("#Main_Span_Error").text("Something Error");
            }, true);
        } catch (x) {
            $("#loadingOverlay").hide();
            $("#Main_Span_Error").text("Something Error");
        }
    });


    //---go to step 3 //this is not using
    function Div_Step3(event) {
        try {
            debugger;
            event.preventDefault();

            var data = { MarksUploadtype: "UploadWithExcelFile" };
            $("#loadingOverlay").show();
            performCrudOperationCommonFunction("GET", "/Results/PublishResults_Step3", data, function (response) {

                $("#Div_UploadingType").html(response);
                $("#loadingOverlay").hide();
            }, function (error) {
                $("#loadingOverlay").hide();
                $("#Main_Span_Error").text("Something Error");
            });
            $("#Div_Step2").hide();
            $("#Div_Step3").show();
            $("#loadingOverlay").hide();

        } catch (x) {
            $("#loadingOverlay").hide();
            $("#Main_Span_Error").text("Something Error");
        }
    }

    //function restrictCharacters_AllowDots1(element) {

    //    debugger;
    //   // element.value = element.value.replace(/(\..*)\./g, '$1');
    //    element.value = element.value.replace(/[^\d.]|(\..*)\./g, '$1');
    //}

    //function restrictCharacters_AllowDots12(element) {
    //    // Get the current value of the input
    //    var value = element.value;

    //    // Check for multiple occurrences of dots
    //    value = value.replace(/(\..*)\./g, '$1');

    //    // Check for multiple occurrences of hyphens
    //    value = value.replace(/(-.*)-/g, '$1');

    //    // Update the input value
    //    element.value = value;
    //}




    //---back to step 1
    function BackTOStep(event, button) {
        try {
            debugger;
            var btnName = $(button).attr("id");
            $(".ErrorMessageSpan").empty();
            $("#loadingOverlay").show();

            $("#Div_Step3").css('display', 'none');
            $("#Div_UploadingType").empty();


            if (btnName == "BtnBackTo_Step2") {

                TblDataTableWithColumns_CallingFunction(event, 'NoStop', '/Results/TblExamSubjects_Calingfunction', 'TblExamSubjects', 'Counts', 'FmSubjectsSearch', 'Div_TblExamSubjects', '', [], false);
                $("#Div_Step2").css('display', 'block');
            } else {
                $("#Div_Step2").css('display', 'none');

                $("#TblExamSubjects tbody").empty();
                $("#Div_Step1").css('display', 'block');
            }

            $("#loadingOverlay").hide();
        } catch (x) {
            $("#loadingOverlay").hide();
            $("#Main_Span_Error").text("Something Error");
        }
    }


    //-----------Search Records
    js("#FmSubjectsSearch").submit(function (event) {
        debugger;
        try {
            event.preventDefault();
            $(".ErrorMessageSpan").empty();
            var formElement = document.getElementById('FmSubjectsSearch');
            setTimeout(function () {
                var validationMessages = formElement.getElementsByClassName('field-validation-error');
                // var validationMessages2 = formElement.getElementsByClassName('error2');
                var validationmelength = validationMessages.length;
                if (validationmelength == 0) {
                    var selectedCount = $('#DdlSubjects option:selected').length;
                    if (selectedCount > 1 && $("#DdlExammode").val() == 2) {
                        $("#Main_Span_Error").text("You can not post results for more than 1 subject in ReTest mode.");
                        window.scrollTo(0, 0);
                        return;
                    } else if (selectedCount > 14) {
                        $("#Main_Span_Error").text("You can not post results for more than 15 subjects at a time.");
                        window.scrollTo(0, 0);
                        return;
                    }
                    TblDataTableWithColumns_CallingFunction(event, 'NoStop', '/Results/TblExamSubjects_Calingfunction', 'TblExamSubjects', 'Counts', 'FmSubjectsSearch', 'Div_TblExamSubjects', '', [], false);
                    //Header Text
                    $("#DepartmentName").text('Step 2 Selection: ' +
                        $("#DdlDepartment option:selected").text() + ' - ' +
                        $("#DdlClass option:selected").text() + ',' +
                        $("#DdlExam option:selected").text() + ',' +
                        $("#DdlExammode option:selected").text() + '');
                    $("#Div_Step2").css('display', 'block');
                    $("#Div_Step1").css('display', 'none');
                } else {
                    $('.alert-danger p').text("Pleae Enter All Required Fields");
                    $(".alert-danger").show().delay(5000).fadeOut()
                }
            }, 50);
        } catch (e) {
            $("#loadingOverlay").hide();
            $("#Main_Span_Error").text("Something Error");
        }
    })

    //=---------------------This is For save and go to step3
    js(document).on("click", '#BtnSave_Nextpage_Step3', function (event) {
        try {
            event.preventDefault();
            //event.stopImmediatePropagation();

            $("#loadingOverlay").show();
            var ButtonName = $(this).val();
            debugger;
            $(".ErrorMessageSpan").empty();
            var formData = new FormData($("#FmSubjectsSearch")[0]);

            var selectedValues = $("#DdlSubjects option:selected").map(function () {
                return $(this).text();
            }).get();
            if (selectedValues) {
                var selectedValuesString = selectedValues.join(", ");
            }
            formData.append("SubjectsName", selectedValuesString)

            // var Subjectname = $("#Subjectname").val();
            var shouldExit = false;
            var TblExamSubject = $("#TblExamSubjects tbody tr");
            TblExamSubject.find('input[type="text"],input[type="date"]').removeClass("errorboxshadow");
            //this for check a record
            TblExamSubject.each(function (index) {
                TblExamSubjectTD = $(this).find("td");
                //var ExamId = TblExamSubjectTD.find("#ExamSubjectId").val();

                var HdnExamSubjectId = TblExamSubjectTD.find("#ExamSubjectId").val();
                var HdnActualDateConducted = TblExamSubjectTD.find("#ActualDateConducted").val();
                var HdnSubjectId = TblExamSubjectTD.find("#SubjectId").val();
                var SubjectName = TblExamSubjectTD.eq(1).text();
                var TxtDate = TblExamSubjectTD.find("#TxtDate").val();
                var TxtPassMarks = TblExamSubjectTD.find("#TxtPassMarks").val();
                var TxtMaxMarks = TblExamSubjectTD.find("#TxtMaxMarks").val();
                if (TxtDate === "") {
                    $(ErrorAppend).text("Conducted date can not be left blank for subject '" + SubjectName + "'");
                    TblExamSubjectTD.find("#TxtDate").addClass("errorboxshadow");
                    shouldExit = true; // Set the flag to true to exit the loops
                    return false; // Exit the inner loop
                }
                else if (TxtPassMarks === "") {
                    $(ErrorAppend).text("Pass Marks can not be left blank for subject '" + SubjectName + "'");
                    TblExamSubjectTD.find("#TxtPassMarks").addClass("errorboxshadow");
                    shouldExit = true; // Set the flag to true to exit the loops
                    return false; // Exit the inner loop
                }
                else if (TxtMaxMarks === "") {
                    $(ErrorAppend).text("Max Marks can not be left blank for subject '" + SubjectName + "'");
                    TblExamSubjectTD.find("#TxtMaxMarks").addClass("errorboxshadow");
                    shouldExit = true; // Set the flag to true to exit the loops
                    return false; // Exit the inner loop
                }
                else if (!compareDatesNotGreaterThanToday(TxtDate)) {
                    $(ErrorAppend).text("Conducted date can not be greater than today for subject '" + SubjectName + "'");
                    TblExamSubjectTD.find("#TxtDate").addClass("errorboxshadow");
                    shouldExit = true; // Set the flag to true to exit the loops
                    return false; // Exit the inner loop
                }
                else if (new Date(TxtDate) < new Date(HdnActualDateConducted)) {
                    $(ErrorAppend).text("ReTest Conducted date can not be less than Conducted Date for subject '" + SubjectName + "'");
                    TblExamSubjectTD.find("#TxtDate").addClass("errorboxshadow");
                    shouldExit = true; // Set the flag to true to exit the loops
                    return false; // Exit the inner loop
                }
                else if (parseFloat(TxtMaxMarks) < parseFloat(TxtPassMarks)) {
                    $(ErrorAppend).text("Pass Marks can not be greater than Max Marks for subject '" + SubjectName + "'");
                    TblExamSubjectTD.find("#TxtPassMarks").addClass("errorboxshadow");
                    shouldExit = true; // Set the flag to true to exit the loops
                    return false; // Exit the inner loop
                }
                // formData.append("ExamIdList", parseInt(ExamId) || 0);
                formData.append("SubjectIdList", parseInt(HdnSubjectId) || 0);
                formData.append("PassMarksList", parseFloat(TxtPassMarks));
                formData.append("MaxMarksList", parseFloat(TxtMaxMarks));
                formData.append("DateConductedList", TxtDate);

                formData.append("ExamSubjectIdList", parseInt(HdnExamSubjectId) || 0);
            });
            if (shouldExit) {
                //  $("#Main_Span_Error").text("Subjects overlapping.");
                window.scrollTo(0, 0);
                $("#loadingOverlay").hide();
                return;
            }
            performCrudOperationCommonFunction('POST', "/Results/PostResults?ButtonName=" + ButtonName, formData, function (response) {
                debugger;
                var SubjectText = "";
                //var jsonResponse = JSON.parse(response.name);

                if (response.message == "Record inserted successfully.") {
                    $("#DepartmentNameStep3").text('Step 2 Selection: ' +
                        $("#DdlDepartment option:selected").text() + ' - ' +
                        $("#DdlClass option:selected").text() + ',' +
                        $("#DdlExam option:selected").text()); 
                   // var data = { MarksUploadtype: "UploadWithExcelFile",Nextstep:"Step3" };
                    var MarksUploadtype = "UploadWithExcelFile";
                    $("#loadingOverlay").show();
                    performCrudOperationCommonFunction("POST", "/Results/PublishResults_Step3?MarksUploadtype=" + MarksUploadtype + "&Nextstep=Step3", formData, function (response) {
                        $("#Div_UploadingType").html(response);
                        $("#Div_Step2").hide();
                        $("#Div_Step3").show();
                        $("#loadingOverlay").hide();
                    }, function (error) {
                        $("#loadingOverlay").hide();
                        $("#Main_Span_Error").text("Something Error");
                    }, true);

                }
                //if (response.message == "Users Cannot be De-associated either Attendance / Result has been Posted for the subject") {
                //   // SubjectText = $("#DdlSubject option:selected").text();
                //    $("#Main_Span_Error").text(response.message + SubjectText);
                //}
               else
                    $("#Main_Span_Error").text(response.message + SubjectText);
                


                $("#loadingOverlay").hide();
                window.scrollTo(0, 0);
            }, function (error) {
                $("#loadingOverlay").hide();
                $("#Main_Span_Error").text("Something Error");
            }, true);
        } catch (e) {
            $("#loadingOverlay").hide();
            $("#Main_Span_Error").text("Something Error");
        }
    });

    //-----save file
    js(document).on("click", "#BtnExcelValidate", function (event) {
        try {
            event.preventDefault();
            var ButtonName = $(this).val();
            var ButtonId = $(this).attr("id");
            debugger;
            $(".ErrorMessageSpan").empty();

            var formData = new FormData($("#FmSubjectsSearch")[0]);
          
            var fileInput = document.getElementById("ExcelFile");
            formData.append("File", fileInput)
            var formElement = document.getElementById('FmSubjectsSearch');
            setTimeout(function () {
                var validationMessages = formElement.getElementsByClassName('field-validation-error');
                // var validationMessages2 = formElement.getElementsByClassName('error2');
                var validationmelength = validationMessages.length;
                if (validationmelength == 0) {
                    debugger;
                    performCrudOperationCommonFunction('POST', "/Results/PublishResults?ButtonName=" + ButtonName, formData, function (response) {
                        debugger;
                       // var jsonResponse = JSON.parse(response.message);


                        $("#loadingOverlay").hide();
                        window.scrollTo(0, 0);
                    }, function (error) {
                        $("#loadingOverlay").hide();
                        $("#Main_Span_Error").text("Something Error");
                    }, true);
                }
            }, 50);


            var formData = new FormData($("#FmSubjectsSearch")[0]);
            performCrudOperationCommonFunction('POST', "/Results/PublishResults?ButtonName=" + ButtonName, formData, function (response) {
                debugger;
                var jsonResponse = JSON.parse(response.message);

             
                $("#loadingOverlay").hide();
                window.scrollTo(0, 0);
            }, function (error) {
                $("#loadingOverlay").hide();
                $("#Main_Span_Error").text("Something Error");
            }, true);
        } catch (e) {
            $("#loadingOverlay").hide();
            $("#Main_Span_Error").text("Something Error");
        }
    });




    //=---------------------This is For save as draft and Publish Marks
    js(document).on("click", '#BtnSaveAsDraft,#BtnPublish', function (event) {
        try {
            event.preventDefault();

            $("#loadingOverlay").show();
            //event.stopImmediatePropagation();
            var ButtonName = $(this).val();
            var ButtonId = $(this).attr("id");
            debugger;
            $(".ErrorMessageSpan").empty();
            var formData = new FormData($("#FmSubjectsSearch")[0]);

            formData.append("ButtonId", ButtonId);
            formData.append("EMAILtoParents", $("#chkEMAILPARENTS").is(':checked'));
            formData.append("EMAILtoStudents", $("#chkEMAILSTUDENTS").is(':checked'));
            formData.append("SMStoParent", $("#chkSMSParent").is(':checked'));
            formData.append("SMStoStudent", $("#chkSMSStudent").is(':checked'));


            var TblExamSubject = $("#TblUsersSearched tbody tr");
            TblExamSubject.find('input[type="text"]').removeClass("errorboxshadow");

            var SecuredMarks;
            var shouldExit = false;
            var MaxMarks;
            var Grade;
            $('#TblUsersSearched tbody tr').each(function () {
                if (shouldExit) {
                    return false; // Exit the outer loop
                }
                var UserId = $(this).find('#UserId').val();
                var Name = $(this).find("td:eq(1)").text();
                $(this).find('td').each(function (tdIndex) {
                    if (tdIndex < 3) {
                        return;
                    }
                    SecuredMarks = $(this).find('input[type="text"]').val();
                    SubjectId = $('#TblUsersSearched thead th:eq(' + tdIndex + ')  #TH_ExamSubjectId').val();
                    MaxMarks = $('#TblUsersSearched thead th:eq(' + tdIndex + ')  #TH_MaxMarks').val();
                    PassMarks = $('#TblUsersSearched thead th:eq(' + tdIndex + ')  #TH_PassMarks').val();
                    SubjectName = $('#TblUsersSearched thead th:eq(' + tdIndex + ')').text();

                    if (SecuredMarks === "" && !$(this).find('input[type="text"]').prop('disabled') && ButtonId != "BtnSaveAsDraft") {
                        $(ErrorAppend).text("Please enter marks For student '" + Name + "' for subject  '" + SubjectName + "'");
                        $(this).find('input[type="text"]').addClass("errorboxshadow");
                        shouldExit = true; // Set the flag to true to exit the loops
                        return false; // Exit the inner loop
                    }
                    if (parseFloat(MaxMarks) < parseFloat(SecuredMarks)) {
                        $(ErrorAppend).text("For student '" + Name + "' secured marks can not be greater than maximum marks for subject '" + SubjectName + "'");
                        $(this).find('input[type="text"]').addClass("errorboxshadow");
                        shouldExit = true; // Set the flag to true to exit the loops
                        return false; // Exit the inner loop
                    }

                    if (parseFloat(PassMarks) <= parseFloat(SecuredMarks) && SecuredMarks != "") {
                        Grade = "PASS";
                    } else if (parseFloat(PassMarks) > parseFloat(SecuredMarks) && SecuredMarks != "") {
                        Grade = "FAIL";
                    } else if (SecuredMarks == "-"){
                        Grade = "ABSENT";
                        //Grade = "OPTIONAL";
                    } else if (SecuredMarks == "" && ButtonId == "BtnPublish"){
                        Grade = "OPTIONAL";
                    } else {
                        Grade = "";
                    }
                    formData.append("UseridList", parseInt(UserId) || 0);
                    formData.append("SubjectIdList", parseInt(SubjectId) || 0);
                    formData.append("SecureMarksList", parseFloat(SecuredMarks) || "");
                    // formData.append("SecureMarksList", parseFloat(SecuredMarks));
                    formData.append("GradeList", Grade || "");
                    // formData.append("GradeList", Grade);
                    formData.append("PassMarksList", parseFloat(PassMarks));
                    formData.append("MaxMarksList", parseFloat(MaxMarks));
                    // formData.append("DateConductedList", TxtDate);
                    // formData.append("UserMarksString", count + ', ' + UserId + ',' + SubjectId + ',' + SecuredMarks + ', ' + Grade + ', ' + ButtonWise + ', "Empty"');
                    //  count++;
                });
            });
            if (shouldExit) {
                window.scrollTo(0, 0);
                $("#loadingOverlay").hide();
                return;
            }
            performCrudOperationCommonFunction('POST', "/Results/PublishResults?ButtonName=" + ButtonName, formData, function (response) {
                debugger;
                var jsonResponse = JSON.parse(response.message);
               // var SuccessMSG = jsonResponse.successMSG;
              
                if (jsonResponse.successMSG == "Results Posted successfully.") {
                    $("#Main_Span_Error").text(jsonResponse.successMSG);
                    if ($("#chkEMAILSTUDENTS").is(':checked')) {
                        $("#StudentEmail_Error").text(jsonResponse.emailNotAvailableStudentNames + "  No EMail Id Exists for Students(s).");
                    }
                    if ($("#chkEMAILPARENTS").is(':checked')) {
                        $("#ParentEmail_Error").text(jsonResponse.emailNotAvailableParentNames + "  No EMail Id Exists for Parent(s).");
                    }
                    if ($("#chkSMSStudent").is(':checked')) {
                        $("#StudentSMS_Error").text("For User(s) " + jsonResponse.phoneNotAvailableStudent + " No Mobile Number Exists for Student(s).");
                    }
                    if ($("#chkSMSParent").is(':checked')) {
                        $("#ParentSMS_Error").text("For User(s) " + jsonResponse.phoneNotAvailableParent + "  No Mobile Number Exists for Parent(s).");
                    }
                    //$("#StudentEmail_Error").text(jsonResponse.emailNotAvailableStudentNames);
                    //$("#ParentEmail_Error").text(jsonResponse.emailNotAvailableParentNames );
                    //$("#StudentSMS_Error").text( jsonResponse.phoneNotAvailableStudent );
                    //$("#ParentSMS_Error").text(jsonResponse.phoneNotAvailableParent );

                    $("#BtnPublish").prop("disabled", true);
                    $("#BtnSaveAsDraft").prop("disabled", true);
                } else {
                    $("#Main_Span_Error").text(jsonResponse.successMSG);
                }
                //if (response.message == "Record inserted successfully.") {
                //    var data = { Buttonname: "BtnCreateNew" };
                //    $("#loadingOverlay").show();
                //    //$("#BtnSave").prop('disabled', true);
                //}
                //if (response.message == "Users Cannot be De-associated either Attendance / Result has been Posted for the subject") {
                //    SubjectText = $("#DdlSubject option:selected").text();
                //}
                $("#loadingOverlay").hide();
                window.scrollTo(0, 0);
            }, function (error) {
                $("#loadingOverlay").hide();
                $("#Main_Span_Error").text("Something Error");
            }, true);
        } catch (e) {
            $("#loadingOverlay").hide();
            $("#Main_Span_Error").text("Something Error");
        }
    });


    function ShowIncludeClass() {
        if ($("#chkSMSStudent").prop("checked") || $("#chkSMSParent").prop("checked")) {
            $("#SpnSendRating").css("display", "block");
        } else {
            $("#SpnSendRating").css("display", "none");
        }
    }

</script>
<script src="~/js/ExcelDownloading.js"></script>







